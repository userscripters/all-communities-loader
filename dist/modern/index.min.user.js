// ==UserScript==
// @name           All Communities Loader
// @author         Oleg Valter <o.a.valter@gmail.com>
// @connect        stackexchange.com
// @description    Userscript for loading all communities in the 'visible communities' list
// @grant          GM_xmlhttpRequest
// @homepage       https://github.com/userscripters/all-communities-loader#readme
// @match          https://stackoverflow.com/users/hidecommunities/*
// @match          https://serverfault.com/users/hidecommunities/*
// @match          https://superuser.com/users/hidecommunities/*
// @match          https://*.stackexchange.com/users/hidecommunities/*
// @match          https://askubuntu.com/users/hidecommunities/*
// @match          https://stackapps.com/users/hidecommunities/*
// @match          https://mathoverflow.net/users/hidecommunities/*
// @match          https://pt.stackoverflow.com/users/hidecommunities/*
// @match          https://ja.stackoverflow.com/users/hidecommunities/*
// @match          https://ru.stackoverflow.com/users/hidecommunities/*
// @match          https://es.stackoverflow.com/users/hidecommunities/*
// @match          https://meta.stackoverflow.com/users/hidecommunities/*
// @match          https://meta.serverfault.com/users/hidecommunities/*
// @match          https://meta.superuser.com/users/hidecommunities/*
// @match          https://meta.askubuntu.com/users/hidecommunities/*
// @match          https://meta.mathoverflow.net/users/hidecommunities/*
// @match          https://pt.meta.stackoverflow.com/users/hidecommunities/*
// @match          https://ja.meta.stackoverflow.com/users/hidecommunities/*
// @match          https://ru.meta.stackoverflow.com/users/hidecommunities/*
// @match          https://es.meta.stackoverflow.com/users/hidecommunities/*
// @namespace      userscripters
// @run-at         document-start
// @source         git+https://github.com/userscripters/all-communities-loader.git
// @supportURL     https://github.com/userscripters/all-communities-loader/issues
// @version        1.0.0
// ==/UserScript==

"use strict";((e,l,s)=>{const d=2.3,c="https://api.stackexchange.com",u="IQMwZP9YnpSncK*buTaFuw((",p="all-communities-loader",m={wrapper:".js-community-lists",input:{prompt:".js-community-lists > div > div > p"},visible:{list:{rows:"div:not(:first-child):is(.js-community-lists > div > div)",wrapper:"div:first-of-type"}},hidden:{list:{buttons:"div:is(.js-community-lists > div > div) button",rows:"div:is(.js-community-lists > div > div)",wrapper:"div:nth-of-type(2):is(.js-community-lists > div)"}}},h=(t=1)=>new Promise(e=>setTimeout(e,1e3*t)),w=e=>e.replace(/\s+Stack Exchange$/,"").trim(),g=async(e,t,{page:s=1,pagesize:i=100,...a})=>{var n=t.replace(/^\//,""),n=new URL(`${c}/${d}/`+n),r=new URLSearchParams({page:s.toFixed(0),pagesize:i.toFixed(0),...a});n.search=r.toString();var{items:r,has_more:n,backoff:o}=await(await fetch(n.toString(),{method:e,headers:{"Content-Type":"application/json"}})).json();return o?(await h(o),g(e,t,{page:s,...a})):n?(o=await g(e,t,{page:s+1,pagesize:i,...a}),[...r,...o]):r},v=(a,n,s=1e3)=>new Promise((i,e)=>{var t=a.querySelectorAll(n);t.length&&i(t),new MutationObserver((e,t)=>{var s=a.querySelectorAll(n);s.length&&(t.disconnect(),i(s))}).observe(a,{subtree:!0,childList:!0,attributes:!0}),setTimeout(e,s)}),b=async(e,d,c,t)=>{var s,i,a,[n]=await v(l,m.wrapper);n?([s]=await v(n,m.visible.list.wrapper),s?((await v(s,m.visible.list.rows)).forEach(e=>e.remove()),i=d,a=t,t=e.filter(({site_name:e})=>!a.has(i.get(w(e))||"")).map(e=>{var t,s,i,a,n,{site_name:e,site_url:r}=e,e=w(e),o=d.get(e);return e=e,t=r,s=o||"",r=c.get(r)||"",o=!o,(i=l.createElement("div")).classList.add("d-flex","ai-center","p8","sm:p16","bb","bc-black-075"),(a=l.createElement("div")).classList.add("flex--item","mr6"),(n=l.createElement("img")).width=n.height=36,n.src=r,n.title=e,n.alt=t.replace(/^https:\/\//,""),(r=l.createElement("div")).classList.add("flex--item","fl-grow1","fw-bold"),r.textContent=e,(t=l.createElement("div")).classList.add("flex--item"),(e=l.createElement("button")).classList.add("s-btn","s-btn__filled","js-hide-site"),e.name="hide-site",e.textContent="Hide",e.disabled=o,e.setAttribute("data-hide","true"),e.setAttribute("data-site-id",s),a.append(n),t.append(e),i.append(a,r,t),i}),s.append(...t),null!=(e=n.querySelector(m.input.prompt))&&e.remove()):console.debug(p+": visible communities list wrapper not found")):console.debug(p+": visible communities wrapper not found")};e.addEventListener("load",async()=>{var{hostname:e,pathname:t}=s,e=await(async(e,t)=>{var[{account_id:t}]=await g("get","/users/"+t,{site:e,key:u,filter:"!)HhSg0nAY2wmvmr"});return t})(e.slice(0,e.lastIndexOf(".")),t.replace(/\D/g,""));console.debug(p+": user account id is "+e);const a=await(async s=>{var e=await g("get",`/users/${s}/associated`,{key:u,filter:"*zKJspW7L9qK1Q8K"}),{status:t,responseText:i}=await new Promise((e,t)=>{GM_xmlhttpRequest({url:`https://stackexchange.com/users/${s}?tab=accounts`,onload:e,onerror:t})});return 200===t&&(i=null==(t=$(i).find(".account-site").get().find(e=>e.querySelector("a[href*=area51]")))?void 0:t.querySelector("h2 > a"))&&({href:t,textContent:i}=i,e.push({site_name:w(i||""),site_url:t.replace(/\/users.*$/,"")})),e})(e),n=(a.sort(({site_name:e},{site_name:t})=>e<t?-1:t<e?1:0),console.debug(p+`: ${a.length} associated`),await(async()=>{var e=await g("get","/sites",{key:u,filter:"!KJ20E7-8slWN-NKBj",pagesize:999});const s=new Map;return e.forEach(({icon_url:e,site_url:t})=>s.set(t,e)),s.set("https://area51.stackexchange.com","https://cdn.sstatic.net/Sites/area51/Img/icon-48.png"),s})()),r=(console.debug(p+`: ${n.size} icons fetched`),await(async()=>{const i=new Map;var{status:e,responseText:t}=await new Promise((e,t)=>{GM_xmlhttpRequest({url:"https://stackexchange.com/leagues",onload:e,onerror:t})});return 200===e&&($(t).find(".league-item a").each((e,t)=>{var s=$(t).attr("href"),t=w($(t).text());i.set(t,s.replace(/\D/g,""))}),i.set("Area 51","11")),i})()),o=(console.debug(p+`: ${r.size} site ids fetched`),await(async()=>{const t=new Set;var[e]=await v(l,m.wrapper);return e?([e]=await v(e,m.hidden.list.wrapper),e?e.classList.contains("s-empty-state")?console.debug(p+": no hidden communities found"):(await v(e,m.hidden.list.buttons)).forEach(e=>{e=e.getAttribute("data-site-id");e&&t.add(e)}):console.debug(p+": hidden communities list wrapper not found")):console.debug(p+": hidden communities wrapper not found"),t})());console.debug(p+`: ${null===o||void 0===o?void 0:o.size} hidden site ids found`),await b(a,r,n,o),$(l).ajaxComplete((e,t,{url:s,data:i})=>{s&&["/hide","/unhide"].some(e=>s.endsWith(e))&&i&&((i="object"==typeof i?i.siteId:new URLSearchParams(i).get("siteId"))?(s.endsWith("/hide")?o.add(i):o.delete(i),b(a,r,n,o)):console.debug(p+": missing site-id of the updated site"))})})})(window,document,location);