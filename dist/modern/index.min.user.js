// ==UserScript==
// @author          Oleg Valter <o.a.valter@gmail.com>
// @connect         stackexchange.com
// @description     Userscript for loading all communities in the 'visible communities' list
// @grant           GM_xmlhttpRequest
// @homepage        https://github.com/userscripters/all-communities-loader#readme
// @match           https://*.stackexchange.com/users/hidecommunities/*
// @match           https://askubuntu.com/users/hidecommunities/*
// @match           https://es.meta.stackoverflow.com/users/hidecommunities/*
// @match           https://es.stackoverflow.com/users/hidecommunities/*
// @match           https://ja.meta.stackoverflow.com/users/hidecommunities/*
// @match           https://ja.stackoverflow.com/users/hidecommunities/*
// @match           https://mathoverflow.net/users/hidecommunities/*
// @match           https://meta.askubuntu.com/users/hidecommunities/*
// @match           https://meta.mathoverflow.net/users/hidecommunities/*
// @match           https://meta.serverfault.com/users/hidecommunities/*
// @match           https://meta.stackoverflow.com/users/hidecommunities/*
// @match           https://meta.superuser.com/users/hidecommunities/*
// @match           https://pt.meta.stackoverflow.com/users/hidecommunities/*
// @match           https://pt.stackoverflow.com/users/hidecommunities/*
// @match           https://ru.meta.stackoverflow.com/users/hidecommunities/*
// @match           https://ru.stackoverflow.com/users/hidecommunities/*
// @match           https://serverfault.com/users/hidecommunities/*
// @match           https://stackapps.com/users/hidecommunities/*
// @match           https://stackoverflow.com/users/hidecommunities/*
// @match           https://superuser.com/users/hidecommunities/*
// @name            All Communities Loader
// @namespace       userscripters
// @run-at          document-start
// @source          git+https://github.com/userscripters/all-communities-loader.git
// @supportURL      https://github.com/userscripters/all-communities-loader/issues
// @version         1.0.0
// ==/UserScript==

"use strict";((e,u,i)=>{const p=2.3,m="https://api.stackexchange.com",d="IQMwZP9YnpSncK*buTaFuw((",l="all-communities-loader",h={wrapper:".js-community-lists",input:{prompt:".js-community-lists > div > div > p"},visible:{list:{rows:"div:not(:first-child):is(.js-community-lists > div > div)",wrapper:"div:first-of-type"}},hidden:{list:{buttons:"div:is(.js-community-lists > div > div) button",rows:"div:is(.js-community-lists > div > div)",wrapper:"div:nth-of-type(2):is(.js-community-lists > div)"}}},w=(t=1)=>new Promise(e=>setTimeout(e,1e3*t)),g=e=>e.replace(/\s+Stack Exchange$/,"").trim(),f=async(e,t,{page:s=1,pagesize:i=100,...a})=>{var n=t.replace(/^\//,"");const o=new URL(`${m}/${p}/`+n),r=new URLSearchParams({page:s.toFixed(0),pagesize:i.toFixed(0),...a});o.search=r.toString();const c=await fetch(o.toString(),{method:e,headers:{"Content-Type":"application/json"}});var{items:d,has_more:l,backoff:n}=await c.json();if(n)return await w(n),f(e,t,{page:s,...a});if(l){a=await f(e,t,{page:s+1,pagesize:i,...a});return[...d,...a]}return d},v=(a,n,o=1e3)=>new Promise((i,e)=>{var t=a.querySelectorAll(n);t.length&&i(t);const s=new MutationObserver((e,t)=>{var s=a.querySelectorAll(n);s.length&&(t.disconnect(),i(s))});s.observe(a,{subtree:!0,childList:!0,attributes:!0}),setTimeout(e,o)}),c=async(e,i,a,t)=>{const[s]=await v(u,h.wrapper);if(s){const[r]=await v(s,h.visible.list.wrapper);if(r){const c=await v(r,h.visible.list.rows);c.forEach(e=>e.remove());var n,o,e=(n=i,o=t,e.filter(({site_name:e})=>!o.has(n.get(g(e))||"")).map(e=>{var{site_name:t,site_url:s}=e,e=g(t),t=i.get(e);return((e,t,s,i,a)=>{const n=u.createElement("div");n.classList.add("d-flex","ai-center","p8","sm:p16","bb","bc-black-075");const o=u.createElement("div");o.classList.add("flex--item","mr6");const r=u.createElement("img");r.width=r.height=36,r.src=i,r.title=e,r.alt=t.replace(/^https:\/\//,"");const c=u.createElement("div");c.classList.add("flex--item","fl-grow1","fw-bold"),c.textContent=e;const d=u.createElement("div");d.classList.add("flex--item");const l=u.createElement("button");return l.classList.add("s-btn","s-btn__filled","js-hide-site"),l.name="hide-site",l.textContent="Hide",l.disabled=a,l.setAttribute("data-hide","true"),l.setAttribute("data-site-id",s),o.append(r),d.append(l),n.append(o,c,d),n})(e,s,t||"",a.get(s)||"",!t)}));r.append(...e),null!==(e=s.querySelector(h.input.prompt))&&void 0!==e&&e.remove()}else console.debug(l+": visible communities list wrapper not found")}else console.debug(l+": visible communities wrapper not found")};e.addEventListener("load",async()=>{const{hostname:e,pathname:t}=i;var s=await(async(e,t)=>{var[{account_id:e}]=await f("get","/users/"+t,{site:e,key:d,filter:"!)HhSg0nAY2wmvmr"});return e})(e.slice(0,e.lastIndexOf(".")),t.replace(/\D/g,""));console.debug(l+": user account id is "+s);const a=await(async s=>{const e=await f("get",`/users/${s}/associated`,{key:d,filter:"*zKJspW7L9qK1Q8K"});var{status:t,responseText:i}=await new Promise((e,t)=>{GM_xmlhttpRequest({url:`https://stackexchange.com/users/${s}?tab=accounts`,onload:e,onerror:t})});if(200!==t)return e;const a=$(i),n=a.find(".account-site").get(),o=n.find(e=>e.querySelector("a[href*=area51]"));i=null===o||void 0===o?void 0:o.querySelector("h2 > a");if(i){const{href:r,textContent:c}=i;e.push({site_name:g(c||""),site_url:r.replace(/\/users.*$/,"")})}return e})(s);a.sort(({site_name:e},{site_name:t})=>e<t?-1:t<e?1:0),console.debug(l+`: ${a.length} associated`);const n=await(async()=>{const e=await f("get","/sites",{key:d,filter:"!KJ20E7-8slWN-NKBj",pagesize:999}),s=new Map;return e.forEach(({icon_url:e,site_url:t})=>s.set(t,e)),s.set("https://area51.stackexchange.com","https://cdn.sstatic.net/Sites/area51/Img/icon-48.png"),s})();console.debug(l+`: ${n.size} icons fetched`);const o=await(async()=>{const i=new Map;var{status:e,responseText:t}=await new Promise((e,t)=>{GM_xmlhttpRequest({url:"https://stackexchange.com/leagues",onload:e,onerror:t})});if(200!==e)return i;const s=$(t);return s.find(".league-item a").each((e,t)=>{const s=$(t).attr("href");t=g($(t).text());i.set(t,s.replace(/\D/g,""))}),i.set("Area 51","11"),i})();console.debug(l+`: ${o.size} site ids fetched`);const r=await(async()=>{const t=new Set;var[e]=await v(u,h.wrapper);if(!e)return console.debug(l+": hidden communities wrapper not found"),t;const[s]=await v(e,h.hidden.list.wrapper);if(!s)return console.debug(l+": hidden communities list wrapper not found"),t;if(s.classList.contains("s-empty-state"))return console.debug(l+": no hidden communities found"),t;const i=await v(s,h.hidden.list.buttons);return i.forEach(e=>{e=e.getAttribute("data-site-id");e&&t.add(e)}),t})();console.debug(l+`: ${null===r||void 0===r?void 0:r.size} hidden site ids found`),await c(a,o,n,r),$(u).ajaxComplete((e,t,{url:s,data:i})=>{s&&["/hide","/unhide"].some(e=>s.endsWith(e))&&i&&((i="object"==typeof i?i.siteId:new URLSearchParams(i).get("siteId"))?(s.endsWith("/hide")?r.add(i):r.delete(i),c(a,o,n,r)):console.debug(l+": missing site-id of the updated site"))})})})(window,document,location);